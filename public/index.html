<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vitune Mini Player</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 20px; }
    #results li { margin: 8px 0; cursor: pointer; }
    #controls { margin-top: 12px; }
  </style>
</head>
<body>
  <h1>Vitune Mini Player</h1>
  <form id="searchForm">
    <input type="text" id="query" placeholder="Search song..." required />
    <select id="clientSelect">
      <option value="WEB_REMIX">WEB_REMIX (music.youtube.com)</option>
      <option value="ANDROID">ANDROID (mobile)</option>
      <option value="WEB">WEB (web)</option>
    </select>
    <button type="submit">Search</button>
  </form>

  <ul id="results"></ul>

  <div id="controls">
    <div id="nowPlaying"></div>
    <audio id="player" controls style="width: 100%; margin-top: 8px;"></audio>
  </div>

  <script>
    const form = document.getElementById('searchForm');
    const resultsEl = document.getElementById('results');
    const player = document.getElementById('player');
    const now = document.getElementById('nowPlaying');
    const clientSelect = document.getElementById('clientSelect');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const q = document.getElementById('query').value;
      resultsEl.innerHTML = 'Searching...';
      try {
        const res = await fetch('/api/search?q=' + encodeURIComponent(q));
        const results = await res.json();
        resultsEl.innerHTML = '';
        results.forEach(track => {
          const li = document.createElement('li');
          li.textContent = track.title + ' â€” ' + (track.artist || '');
          li.onclick = () => playTrack(track);
          resultsEl.appendChild(li);
        });
        if (results.length===0) resultsEl.innerHTML = '<li>No results</li>';
      } catch (err) {
        resultsEl.innerHTML = '<li>Error: ' + err.message + '</li>';
      }
    });

    async function playTrack(track) {
      now.textContent = 'Loading: ' + track.title;
      const client = clientSelect.value;
      // Use proxy endpoint to avoid CDN denied
      player.src = '/api/proxy/' + track.videoId + '?client=' + client;
      player.play().catch(e => console.error(e));
    }
  </script>
</body>
</html>
